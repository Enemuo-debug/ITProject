<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zurus06.NAT | Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <link rel="icon" href="./Zurus06.NAT.png" type="image/png">
</head>
<body>
    <header><button id="collapse">
      <svg
        width="24"
        height="24"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <line x1="3" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <line x1="3" y1="18" x2="21" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </button>
    <h1>Zurus06.NAT Dashboard</h1>

    <nav>
      <button id="logout">LOG OUT</button>
    </nav>
  </header>

  <main>
    <aside id="sideLined">
      <div class="profile">
        <img id="userAvatar" src="https://via.placeholder.com/90" alt="User Avatar" />
        <h2 id="username">Loading...</h2>
        <p id="userbio"></p>
        <p id="userjoined"></p>
        <p id="userNiche"></p>
      </div>

      <div class="sidebar-links">
        <a href="/simulations.html">Network Simulations</a>
        <a href="/posts.html">Explore Posts</a>
        <a href="/updateUser.html">Settings</a>
        <a href="https://github.com/Enemuo-debug/Zurus06.NAT--ITProject/blob/main/readme.md">Help</a>
      </div>
    </aside>

    <section class="content">
      <h2 class="section-title">My Posts</h2>

      <div class="create-post-card">
        <h3>+ Create New Post</h3>
        <form id="createPostForm">
          <input type="text" id="postTitle" placeholder="Enter Post Title" maxlength="150" minlength="10" required/>
          <small id="title">0/150</small>
          <textarea id="postIntro" placeholder="Write a short intro..." rows="5" maxlength="700" required></textarea>
          <small id="intro">0/700</small><br>
          <button type="submit" id="createpost">Create Post</button>
        </form>
      </div>

      <!-- ðŸ“° Posts -->
      <div id="posts-container" class="posts-container">
        <p>Loading posts...</p>
      </div>
    </section>
  </main>

  <footer>
    &copy; 2025 Zurus06.NAT â€” All rights reserved.
  </footer>

  <script type="module">
    import { URL } from "./config.js";
    const postsContainer = document.getElementById("posts-container");
    const avatarImg = document.getElementById("userAvatar");
    const TITLE = document.getElementById("postTitle");
    const INTRO = document.getElementById("postIntro");
    const title = document.getElementById("title");
    const intro = document.getElementById("intro");

    TITLE.addEventListener("input", ()=>{
      title.innerText = `${TITLE.value.length}/150`;
    });

    INTRO.addEventListener("input", ()=>{
      intro.innerText = `${INTRO.value.length}/700`;
    });

    const diceBearStyles = {
      Network_Design: "notionists",
      Network_Security: "fun-emoji",
      Network_Management_And_Monitoring: "adventurer",
      Network_Technology_And_Trends: "bottts",
      Networking_Troubleshooting_And_Optimization: "avataaars"
    };

    async function loadDashboard() {
      try {
        const response = await fetch(URL + "/account/me", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
          credentials: "include"
        });

        if (response.status !== 200) {
          alert("You are not logged in. Please sign in again.");
          window.location.href = "/signin.html?page=sign";
          return;
        }

        const userData = await response.json();
        const user = userData.data.userDetails;

        document.getElementById("username").textContent = user.displayName;
        document.getElementById("userbio").textContent = user.bio || "No bio available.";
        document.getElementById("userjoined").textContent =
          "Joined: " + user.joinedAt.split(" ").join("-");
        document.getElementById("userNiche").textContent =
          "Niche: " + user.niche;

        const nicheKey = user.niche.split(" ").join("_");
        const style = diceBearStyles[nicheKey];
        avatarImg.src = `https://api.dicebear.com/7.x/${style}/svg?seed=${user.displayName}&backgroundColor=transparent`;
        renderPosts(userData.data.userPosts.reverse() || []);
      } catch (error) {
        postsContainer.innerHTML = `<p style="color:red;">Error loading dashboard: ${error.message}</p>`;
        alert("You are not logged in. Please sign in again.");
        window.location.href = "/signin.html?page=sign";
        return;
      }
    }

    document.getElementById("collapse").addEventListener("click", ()=>{
      document.getElementById("sideLined").classList.toggle("open");
    })

    document.getElementById("logout").addEventListener("click", async (e) => {
      await fetch(URL + "/account/logout", {
        method: "GET", 
        headers: { "Content-Type": "application/json" },
        credentials: "include"
      });
      window.location = "/signin?page=sign"
    })

    function renderPosts(posts) {
      postsContainer.innerHTML = "";
      if (posts.length === 0) {
        postsContainer.innerHTML = "<p>You havenâ€™t created any posts yet.</p>";
        return;
      }

      posts.forEach(post => {
        const postDiv = document.createElement("div");
        postDiv.classList.add("post");
        if (!post.isPublished)
        {
          postDiv.innerHTML = `
            <h3>${post.caption}</h3>
            <p class="intro">${post.intro}</p>
            <div class="post-actions">
            <button class="edit-btn" data-id="${post.id}">Edit</button>
            <button class="delete-btn" data-id="${post.id}">Delete</button>
            <button class="publish-btn" data-id="${post.id}">Publish</button>
          </div>
          `;
        } else {
          postDiv.classList.add("active")
          postDiv.innerHTML = `
          <h3>${post.caption}</h3>
          <p class="intro">${post.intro}</p>
          <div class="post-actions">
          <button class="edit-btn" data-id="${post.id}">Edit</button>
          <button class="delete-btn" data-id="${post.id}">Delete</button>
            </div>
          `;
        }
        postsContainer.appendChild(postDiv);

        const deleteBtn = postDiv.querySelector(".delete-btn");
        deleteBtn.addEventListener("click", async (e) => {
          const postId = e.target.dataset.id;
            if (!confirm("Are you sure you want to delete this post? This action cannot be undone.")) {
            return;
            }
            try {
              const response = await fetch(`${URL}/posts/${postId}`, {
                method: "DELETE",
                headers: { "Content-Type": "application/json" },
                credentials: "include"
              });
              if (!response.ok || response.status != 200) throw new Error("Failed to delete post");
              postDiv.remove();
            } 
            catch (err) {
              alert("Error deleting post: " + err.message);
            }
          });

          const editBtn = postDiv.querySelector(".edit-btn");
          editBtn.addEventListener("click", (e) => {
            const postId = e.target.dataset.id;
            // Redirect to edit page with the post ID as a URL parameter
            window.location.href = `/editpost.html?id=${postId}`;
          });
        const publishBtn = postDiv.querySelector(".publish-btn");
          if (publishBtn) {
            publishBtn.addEventListener("click", async (e) => {
              const postId = e.target.dataset.id;

              if (!confirm("Are you sure you want to publish this post?")) {
                return;
              }

              try {
                const response = await fetch(`${URL}/posts/${postId}/publish`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  credentials: "include"
                });

                if (!response.ok) {
                  throw new Error("Failed to publish post");
                }

                postDiv.classList.add("active");

                postDiv.querySelector(".post-actions").innerHTML = `
                  <button class="edit-btn" data-id="${postId}">Edit</button>
                  <button class="delete-btn" data-id="${postId}">Delete</button>
                `;

                alert("Post published successfully!");
              } catch (err) {
                alert("Error publishing post: " + err.message);
              }
            });
          }
      });
    }

    document.getElementById("createPostForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("postTitle").value.trim();
      const intro = document.getElementById("postIntro").value.trim();

      try {
        const res = await fetch(URL+"/posts/new", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ caption: title, intro })
        });

        if (!res.ok) throw new Error("Failed to create post");
        const newPost = await res.json();
        window.location.href = `/editpost.html?id=${newPost.data.id}`;
        e.target.reset();
      } catch (err) {
        alert("Error: " + err.message);
      }
    });

    loadDashboard();
  </script>
</body>
</html>